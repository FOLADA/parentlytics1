# მონაცემთა ბაზის დაყენება Parentlytics-სთვის

ეს დოკუმენტი აღწერს ბავშვის პროფილის სისტემის მონაცემთა ბაზის დაყენებას Parentlytics-ში.

## მონაცემთა ბაზის სქემა

### ბავშვის პროფილების ცხრილი

`child_profiles` ცხრილი ინახავს ინფორმაციას თითოეული მომხმარებლის ბავშვის შესახებ:

```sql
CREATE TABLE child_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  birthdate DATE NOT NULL,
  gender TEXT NOT NULL CHECK (gender IN ('male', 'female', 'other')),
  weight NUMERIC(5,2),
  height NUMERIC(5,2),
  activity_level TEXT CHECK (activity_level IN ('low', 'moderate', 'high')),
  allergies TEXT[] DEFAULT '{}',
  other_health_concerns TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### ძირითადი ფუნქციები

- **ერთი პროფილი თითო მომხმარებლისთვის**: უნიკალური ინდექსი `user_id`-ზე უზრუნველყოფს, რომ თითოეულ მომხმარებელს შეიძლება ჰქონდეს მხოლოდ ერთი ბავშვის პროფილი
- **სტრიქონების დონის უსაფრთხოება (RLS)**: მომხმარებლებს შეუძლიათ მხოლოდ საკუთარი ბავშვის პროფილის ხილვა
- **ავტომატური დროის შტამპები**: `created_at` და `updated_at` ავტომატურად მართვის ქვეშაა
- **მონაცემთა ვალიდაცია**: შემოწმების შეზღუდვები უზრუნველყოფს სქესისა და აქტივობის დონის სწორ მნიშვნელობებს

## დაყენების ინსტრუქციები

### 1. გარემოს ცვლადები

დარწმუნდით, რომ გაქვთ შემდეგი გარემოს ცვლადები დაყენებული:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

### 2. მონაცემთა ბაზის დაყენება

გაუშვით მონაცემთა ბაზის დაყენების სკრიპტი:

```bash
npm run setup-db
```

### 3. დაყენების შემოწმება

შეამოწმეთ, რომ ყველა ცხრილი არსებობს:

```bash
npm run check-db
```

## ავთენტიფიკაციის ნაკადი

### 1. მომხმარებლის რეგისტრაცია/შესვლა
- მომხმარებლები რეგისტრირდებიან ან შედიან ავთენტიფიკაციის სისტემის მეშვეობით
- სესია დამყარდება Supabase Auth-ით

### 2. პროფილის შემოწმება
- შუალედური პროგრამა შემოწმებს, აქვს თუ არა მომხმარებელს ბავშვის პროფილი
- თუ პროფილი არ არსებობს, გადამისამართდება `/setup-child`-ზე
- თუ პროფილი არსებობს, უზრუნველყოფს დაცული მარშრუტებზე წვდომას

### 3. პროფილის დაყენება
- ახალი მომხმარებლები გადამისამართდებიან `/setup-child`-ზე
- ფორმა აგროვებს ბავშვის ინფორმაციას
- მონაცემები ინახება `child_profiles` ცხრილში
- მომხმარებელი გადამისამართდება `/profile`-ზე დაყენების შემდეგ

### 4. პროფილის მართვა
- მომხმარებლებს შეუძლიათ ნახონ საკუთარი ბავშვის პროფილი `/profile`-ზე
- პროფილი შეიძლება იყოს რედაქტირებული ინლაინად
- ცვლილებები ინახება მონაცემთა ბაზაში

## API ბოლოები

### ბავშვის პროფილის მართვა

- `GET /api/child-profile` - მიმდინარე მომხმარებლის ბავშვის პროფილის მიღება
- `POST /api/child-profile` - ახალი ბავშვის პროფილის შექმნა
- `PUT /api/child-profile` - არსებული ბავშვის პროფილის განახლება

### ავთენტიფიკაცია

- `POST /api/auth/signup` - მომხმარებლის რეგისტრაცია
- `POST /api/auth/login` - მომხმარებლის შესვლა
- `POST /api/auth/logout` - მომხმარებლის გასვლა

## უსაფრთხოების ფუნქციები

### სტრიქონების დონის უსაფრთხოება (RLS)

შემდეგი პოლიტიკები გადატარდება `child_profiles` ცხრილზე:

```sql
-- მომხმარებლებს შეუძლიათ ნახონ საკუთარი ბავშვის პროფილი
CREATE POLICY "Users can view own child profile" ON child_profiles
  FOR SELECT USING (auth.uid() = user_id);

-- მომხმარებლებს შეუძლიათ ჩასვან საკუთარი ბავშვის პროფილი
CREATE POLICY "Users can insert own child profile" ON child_profiles
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- მომხმარებლებს შეუძლიათ განაახლონ საკუთარი ბავშვის პროფილი
CREATE POLICY "Users can update own child profile" ON child_profiles
  FOR UPDATE USING (auth.uid() = user_id);

-- მომხმარებლებს შეუძლიათ წაშალონ საკუთარი ბავშვის პროფილი
CREATE POLICY "Users can delete own child profile" ON child_profiles
  FOR DELETE USING (auth.uid() = user_id);
```

### მონაცემთა ვალიდაცია

- **სქესი**: უნდა იყოს 'male', 'female', ან 'other'
- **აქტივობის დონე**: უნდა იყოს 'low', 'moderate', ან 'high'
- **წონა/სიმაღლე**: რიცხვითი მნიშვნელობები შესაბამისი სიზუსტით
- **დაბადების თარიღი**: უნდა იყოს სწორი თარიღი და არ უნდა იყოს მომავალში

## შეცდომების დამუშავება

სისტემა შეიცავს სრულყოფილ შეცდომების დამუშავებას:

- **მონაცემთა ბაზის შეცდომები**: ჟურნალში ჩაწერა და მომხმარებლისთვის მეგობრული შეტყობინებების ჩვენება
- **ვალიდაციის შეცდომები**: ფორმის ვალიდაცია კონკრეტული შეცდომის შეტყობინებებით
- **ავთენტიფიკაციის შეცდომები**: სწორი გადამისამართება და შეცდომის მდგომარეობები
- **ქსელის შეცდომები**: გამეორების მექანიზმები და დარეზერვებული მდგომარეობები

## ტესტირება

სისტემის ტესტირება:

1. **ახალი მომხმარებლის ნაკადი**:
   - რეგისტრაცია → გადამისამართება `/setup-child`-ზე → პროფილის შექმნა → გადამისამართება `/profile`-ზე

2. **არსებული მომხმარებლის ნაკადი**:
   - შესვლა → პროფილის შემოწმება → თუ არსებობს, გადადის `/profile`-ზე; თუ არა, გადადის `/setup-child`-ზე

3. **პროფილის რედაქტირება**:
   - ეწვიეთ `/profile`-ს → დააჭირეთ რედაქტირებას → შეცვალეთ ველები → შეინახეთ ცვლილებები

## პრობლემების გადაჭრა

### საერთო პრობლემები

1. **"ცხრილი არ არსებობს" შეცდომა**:
   - გაუშვით `npm run setup-db` ცხრილების შესაქმნელად

2. **ავთენტიფიკაციის შეცდომები**:
   - შეამოწმეთ გარემოს ცვლადები
   - შეამოწმეთ Supabase პროექტის პარამეტრები

3. **RLS პოლიტიკის შეცდომები**:
   - დარწმუნდით, რომ მომხმარებელი ავთენტიფიცირებულია
   - შეამოწმეთ, რომ პოლიტიკები სწორადაა გადატარებული

### გამართვის ბრძანებები

```bash
# მონაცემთა ბაზის სტატუსის შემოწმება
npm run check-db

# ჟურნალის ნახვა
npm run dev

# API ბოლოების ტესტირება
curl -X GET http://localhost:3001/api/child-profile
```

## მომავალი გაუმჯობესებები

- მრავალი ბავშვი თითო მომხმარებლისთვის
- პროფილის გაზიარება მშობლებს შორის
- განვითარებული ჯანმრთელობის თვალყურის დევნება
- ინტეგრაცია გარე ჯანდაცვის API-ებთან
- ექსპორტი/იმპორტის ფუნქციონალი